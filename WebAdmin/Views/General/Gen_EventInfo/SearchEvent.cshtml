@using CLL
@model BDO.Core.DataAccessObjects.Models.gen_eventinfoEntity
@inject CLL.Localization.LocalizeService SharedLocalizer

@using Microsoft.Extensions.Options
@{
    ViewData["Title"] = "Search Event";
}


<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-footer">
                <h5 class="card-title">@SharedLocalizer.GetLocalizedHtmlString("GEN_EVENTINFOY_LIST")</h5>
            </div>
            <!-- /.card-header -->
            <div class="card-body">
                <form method="POST" id="frmAddGen_EventInfo" class="my-login-validation" novalidate="" autocomplete="off">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="labelNormal" asp-for="eventcategoryid"></label>
                                    @await Component.InvokeAsync("S2Gen_EventCategory", new { selectid = "eventcategoryid", preloaded = ViewBag.preloadedDatagen_eventcategory, isReadOnly = false, multiple = false, isRequired = true, pkey = -99 })
                                    <span asp-validation-for="eventcategoryid" class="eventcategoryiderror text-danger " id="eventcategoryiderror"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="labelNormal" asp-for="eventid"></label>
                                    @await Component.InvokeAsync("S2Gen_Event", new { selectid = "eventid", preloaded = ViewBag.preloadedDatagen_event, isReadOnly = false, multiple = false, isRequired = true, pkey = -99 })
                                    <span asp-validation-for="eventid" class="eventiderror text-danger " id="eventcategoryiderror"></span>

                                    @*   <label class="labelNormal" asp-for="eventname"></label>
                                    <input asp-for="eventname" class="form-control" required></input>
                                    <span asp-validation-for="eventname" class="eventnameerror text-danger " id="eventnameerror"></span>*@
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="labelNormal" asp-for="eventcode"></label>
                                    <input asp-for="eventcode" class="form-control" autocomplete="off" required />
                                    <span asp-validation-for="eventcode" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                        <div class="row ">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="labelNormal" asp-for="eventstartdate"></label>
                                    <div class="input-group date bs-datepicker">
                                        <input asp-for="eventstartdate" class="form-control " type="text" placeholder="dd/mm/yyyy" />
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">
                                                <i class="far fa-calendar-alt"></i>
                                            </span>
                                        </div>
                                    </div>
                                    <span asp-validation-for="eventstartdate" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="labelNormal" asp-for="eventenddate"></label>
                                    <div class="input-group date bs-datepicker">
                                        <input asp-for="eventenddate" class="form-control " type="text" placeholder="dd/mm/yyyy" />
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">
                                                <i class="far fa-calendar-alt"></i>
                                            </span>
                                        </div>
                                    </div>
                                    <span asp-validation-for="eventenddate" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="row btn-toolbar">
                                <div class="col-md-6 ">
                                    <div class="form-group">
                                        <button type="submit" id="btnSearchEventInfo" class="btn btn-primary btn-md"><i class="fa fa-search"></i> @SharedLocalizer.GetLocalizedHtmlString("SEARCH_REQUEST")</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="card-body">
                <form method="POST" id="frmDTGen_EventInfolist" class="my-login-validation" novalidate="" autocomplete="off">
                    <div class="row">
                        <div class="col-md-12">
                            <table id="DTGen_EventInfolist" class="table table-striped table-bordered" @*style="width:100%"*@ cellspacing="0">
                                <thead>
                                    <tr>
                                        <th><label class="labelNormal  ">Serial No</label></th>
                                        <th><label class="labelNormal  " asp-for="eventcode"></label></th>
                                        <th><label class="labelNormal  " asp-for="eventname"></label></th>
                                        <th><label class="labelNormal  " asp-for="eventstartdate"></label></th>
                                        <th><label class="labelNormal  ">Files</label></th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>

                </form>
            </div>
            <!-- ./card-body -->
            <div class="card-footer">
                <div class="row">
                    <div class="col-md-12">

                        <!-- /.description-block -->
                    </div>
                    <!-- /.col -->
                </div>
                <!-- /.row -->
            </div>
            <!-- /.card-footer -->
        </div>
        <!-- /.card -->
    </div>
    <!-- /.col -->
</div>


@section Scripts {
    <script>
        $(function() {
	var table;

	$('body').on('click', '#btnSearchEventInfo', function(e) {
		try {
			event.preventDefault();
			loadSearch();
		} catch (e) {
			showErrorAlert("Error", e.message, "OK");
		}
	});

	function loadSearch() {
		try {
			table.destroy();
		} catch {}
	



	var dataobject = {
		eventcategoryid: $("#eventcategoryid").val(),
		eventcode: $("#eventcode").val(),
		eventname: $("#eventname").val(),
		eventstartdate: GetDateFromTextBox($("#eventstartdate").val()),
		eventenddate: GetDateFromTextBox($("#eventenddate").val()),
	}

	table = $("#DTGen_EventInfolist").DataTable({
		"ajax": $.fn.dataTable.json({
			url: "/Gen_EventInfo/SearchEventInfo",
			data: dataobject
		}),
		"buttons": {
			"buttons": []
		},

		"columns": [
                        {
                            "data": "eventcode",
                            "name": "eventcode",
                            "autoWidth": true,
                            "render": function (data, type, row, meta) {
                                return meta.row + 1; // Row numbers start from 1
                            }
                        },
            {
				"data": "eventcode",
				"name": "eventcode",
				"autoWidth": true
			},
			{
				"data": "eventname",
				"name": "eventname",
				"autoWidth": true
			},
			{
				"data": "eventstartdate",
				"name": "eventstartdate",
				"autoWidth": true,
				render: function(data, type, full, row) {
					return moment(data).format("DD-MM-YYYY h:mm a");
				}
			},
			{
				"data": "ex_nvarchar1",
				"name": "ex_nvarchar1",
				"autoWidth": true,
				"render": function(data, type, full, row) {
                    var nestedTable = "";
					var baseURL = window.location.origin;
					var fileinfo = "";
					if (data != null) {
						// var fileinfo = "";
						// //var datainfo = data;
						const myArray = data.split(",");
						//console.log(myArray)

						nestedTable = "<table class='table table-striped table-bordered '>"

						$.each(myArray, function(key, value) {
							nestedTable += "<tr>";
							nestedTable += "<td>";

							var strArr = value.split("|");
							var fileName = strArr[0];
							var fileDesc = strArr[1];

							//console.log(fileName)
							fileinfo = "<img width='100' height='100' src='" + baseURL + "/uploads/" + fileName + "'> </img>";
							nestedTable += fileinfo;
							nestedTable += "</td>";
							nestedTable += "<td>" + fileDesc + "</td>";
							nestedTable += "<td><a href='" + baseURL + "/uploads/" + fileName + "' download>Download</a></td>";
							nestedTable += "</tr>";
						});
                        nestedTable += "</table>";
					}
					
					return nestedTable;
				}
			}
		]
	});

    }

	$('.bs-datepicker').datepicker({
		format: "dd/mm/yyyy",
		autoclose: true,
		clearBtn: true,
		startView: 0,
		language: "en",
		todayHighlight: true
	});
	//$('.bs-datepicker').datepicker({
	//    format: "dd/mm/yyyy",
	//    autoclose: true,
	//    clearBtn: true,
	//    startView: 0,
	//    language: "en",
	//    todayHighlight: true
	//});
});

    </script>
}



